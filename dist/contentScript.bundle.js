(()=>{"use strict";const e={HOME:"home",PLAYLIST:"playlist",PLAYER:"player",CHANNEL_INDEX:"channel-index"},t={[e.PLAYER]:"/watch",[e.PLAYLIST]:"/playlist",[e.CHANNEL_INDEX]:"/@",[e.HOME]:"/"},a={[e.PLAYER]:"#related",[e.HOME]:'.ytd-browse[page-subtype="home"] #contents',[e.CHANNEL_INDEX]:'.ytd-browse[page-subtype="channels"] #contents',[e.PLAYLIST]:'.ytd-browse[page-subtype="playlist"] #contents'},o=e=>a[e],n="settings",s="enabledLocations",r="statsEnabled",c="debugLogsEnabled",i=()=>browser.storage.local,l=async()=>(await i().get(n))[n]||null,d=e=>!0===e||!1===e,y=async()=>(await l())[s],w=async()=>{const t=await l();return(t=>{return t&&(t=>{if(!Array.isArray(t))return!1;for(const a of t)if(!Object.values(e).includes(a))return!1;return!0})(t[s])&&(o=t[r],d(o))&&(a=t[c],d(a));var a,o})(t)?t:(await(async()=>{const t={[n]:{[s]:[e.PLAYER,e.PLAYLIST,e.CHANNEL_INDEX,e.HOME],[r]:!0,[c]:!1}};return await i().set(t),t})(),await l())},u=()=>browser.storage.local,f=async(e,t)=>{const a=await(async e=>(await u().get(e))[e]||{})(e),o=a[t]||0,n={[e]:{...a,[t]:o+1}};u().set(n)},b=async e=>f("locationHideCounts",e),m=async e=>f("hideCounts",e),L=async(...e)=>{await(async()=>!0===(await l())[c])()&&console.log("[Hide Members Only Videos]",...e)},E=e=>e?.textContent?.trim(),h=["ytd-rich-item-renderer","yt-lockup-view-model","ytd-playlist-video-renderer"],g=new Map,A=async(a,o)=>{if((e=>Array.from(e.querySelectorAll(".yt-badge-shape__text")).some(e=>e.textContent.toLowerCase().includes("Members only".toLowerCase())))(a)){const n=await(a=>{switch((()=>{for(const[e,a]of Object.entries(t))if(window.location.pathname.startsWith(a))return e;return null})()){case e.PLAYER:case e.HOME:{const e=a.querySelector("yt-content-metadata-view-model span.yt-content-metadata-view-model__metadata-text");return E(e)}case e.CHANNEL_INDEX:{const e=document.getElementById("page-header"),t=e?.querySelector(".dynamicTextViewModelH1 span.yt-core-attributed-string");return E(t)}case e.PLAYLIST:{const e=a.querySelector(".ytd-channel-name a");return E(e)}default:return null}})(a)||"Unknown";try{await(async(e,t)=>{u()&&(await(async()=>!0===(await l())[r])()?await Promise.all([m(e),b(t)]):console.warn("Statistics are disabled, not incrementing hide counts."))})(n,o)}catch(e){console.error("Failed to increment hide count:",e)}a.remove()}},N=async(e,t)=>{for(const a of h){const o=e.matches(a)?[e]:e.querySelectorAll&&e.querySelectorAll(a);for(const e of o)await A(e,t)}},p=async e=>{const t=await v();if(0!==t.length)for(const a of e){const e=Array.from(a.addedNodes);if(e.length)for(const a of e)if(a.nodeType===Node.ELEMENT_NODE)for(const e of t){const n=o(e),s=a.matches(n)||a.querySelector(n);s&&(await S(s,e),t.splice(t.indexOf(e),1))}}},v=async()=>{const e=await y(),t=Array.from(g.keys()).map(e=>g.get(e).location);return e.filter(e=>!t.includes(e))},S=async(e,t)=>{if(!e?.isConnected)return void await L("No container found for location",t);const a=new MutationObserver(async(a,o)=>{if(!e.isConnected)return await L("Disconnecting observer for location",t),o.disconnect(),void g.delete(e);await(async(e,t)=>{for(const a of e){const e=Array.from(a.addedNodes).filter(e=>e.nodeType===Node.ELEMENT_NODE);for(const a of e)await N(a,t)}})(a,t)});a.observe(e,{childList:!0,subtree:!0}),g.set(e,{observer:a,location:t}),await(async(e,t)=>{for(const a of h)for(const o of e.querySelectorAll(a))await A(o,t)})(e,t),await L("Bound observer for location",t)},M=async e=>{const t=o(e),a=document.querySelector(t);await S(a,e)};browser.runtime.onMessage.addListener(async e=>{e.enabledLocations?.length&&await(async e=>{const t=e.map(async e=>(await L("Starting to observe",e),await M(e),e));await Promise.all(t)})(e.enabledLocations),e.disabledLocations?.length&&await(async e=>{for(const[t,a]of g)e.includes(a.location)&&(a.observer.disconnect(),g.delete(t),await L("Disconnected observer for",a.location))})(e.disabledLocations)});(async()=>{await(async()=>{await w(),await(async()=>{const e=await y();if(e.length)for(const t of e)await M(t);else await L("No locations to hide are enabled.")})(),await(async()=>{const e=new MutationObserver(p),t=document.body.querySelector("#content");e.observe(t,{childList:!0,subtree:!0})})()})()})()})();